generator client {
  provider = "prisma-client-js"
}

generator db {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              Int             @id @default(autoincrement())
  email           String          @unique
  password        String
  role            String
  avatarPath      String?
  Notification    Notification[]
  assignedTickets Ticket[]        @relation("AssignedTickets")
  createdTickets  Ticket[]        @relation("CreatedTickets")
  comments        TicketComment[]
}

model Ticket {
  id           Int                @id @default(autoincrement())
  title        String
  description  String
  priority     String
  statusId     Int
  queueId      Int
  createdById  Int
  assignedToId Int?
  dueAt        DateTime?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  slaBreached  Boolean            @default(false)
  slaNotified  Boolean            @default(false)
  Notification Notification[]
  slaHistory   SLAHistory[]
  assignedTo   User?              @relation("AssignedTickets", fields: [assignedToId], references: [id])
  createdBy    User               @relation("CreatedTickets", fields: [createdById], references: [id])
  queue        TicketQueue        @relation(fields: [queueId], references: [id])
  status       TicketStatus       @relation(fields: [statusId], references: [id])
  comments     TicketComment[]
  attachments  TicketAttachment[]
}

model TicketStatus {
  id      Int      @id @default(autoincrement())
  name    String
  tickets Ticket[]
}

model TicketQueue {
  id      Int      @id @default(autoincrement())
  name    String
  tickets Ticket[]
}

model TicketComment {
  id          Int      @id @default(autoincrement())
  ticketId    Int
  createdById Int
  message     String
  createdAt   DateTime @default(now())
  createdBy   User     @relation(fields: [createdById], references: [id])
  ticket      Ticket   @relation(fields: [ticketId], references: [id])
}

model SLAHistory {
  id         Int       @id @default(autoincrement())
  ticketId   Int
  breachedAt DateTime
  notifiedAt DateTime?
  resolvedAt DateTime?
  createdAt  DateTime  @default(now())
  ticket     Ticket    @relation(fields: [ticketId], references: [id])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  ticketId  Int?
  title     String
  message   String
  type      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime
  Ticket    Ticket?  @relation(fields: [ticketId], references: [id])
  User      User     @relation(fields: [userId], references: [id])
}

model TicketAttachment {
  id           Int      @id @default(autoincrement())
  ticketId     Int
  filename     String
  originalName String
  mimeType     String
  size         Int
  path         String
  createdAt    DateTime @default(now())
  ticket       Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
}
